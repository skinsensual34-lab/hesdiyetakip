<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hediye Takip Sistemi</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f0f2f5;
    --surface: #ffffff;
    --surface2: #f7f8fa;
    --surface3: #eef0f3;
    --border: #e2e5ea;
    --border2: #d0d4dc;
    --accent: #4f6ef7;
    --accent-light: #eef1fe;
    --accent-dark: #3a57e8;
    --text: #1a1d23;
    --text2: #4a5060;
    --muted: #8a909e;
    --green: #22a06b;
    --green-light: #e6f6f0;
    --red: #e5484d;
    --red-light: #fff0f0;
    --blue: #0091ff;
    --blue-light: #e6f4ff;
    --orange: #f76b15;
    --orange-light: #fff4ec;
    --shadow: 0 1px 4px rgba(0,0,0,0.07), 0 4px 16px rgba(0,0,0,0.04);
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:'Plus Jakarta Sans',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }

  /* LOGIN */
  #login-page {
    min-height:100vh; display:flex; align-items:center; justify-content:center;
    background: linear-gradient(135deg, #f0f2f5 0%, #e8ecf4 100%);
  }
  #login-page.hidden { display:none; }
  .login-box {
    background:var(--surface); border:1px solid var(--border); border-radius:20px;
    padding:48px 40px; width:400px; text-align:center; box-shadow: var(--shadow);
  }
  .login-logo {
    font-size:2.2rem; margin-bottom:8px;
  }
  .login-title { font-size:1.4rem; font-weight:700; color:var(--text); margin-bottom:4px; }
  .login-sub { color:var(--muted); font-size:0.88rem; margin-bottom:32px; }
  .login-box input {
    width:100%; padding:12px 16px; background:var(--surface2); border:1.5px solid var(--border);
    border-radius:10px; color:var(--text); font-size:0.95rem; margin-bottom:12px;
    font-family:'Plus Jakarta Sans',sans-serif; transition:border-color 0.2s;
  }
  .login-box input:focus { outline:none; border-color:var(--accent); background:white; }
  .btn-login {
    width:100%; padding:13px; background:var(--accent); color:white; font-weight:700;
    border:none; border-radius:10px; font-size:0.95rem; cursor:pointer;
    font-family:'Plus Jakarta Sans',sans-serif; transition:background 0.2s; margin-top:4px;
    box-shadow: 0 4px 14px rgba(79,110,247,0.3);
  }
  .btn-login:hover { background:var(--accent-dark); }
  .login-error { color:var(--red); font-size:0.85rem; margin-top:10px; display:none; background:var(--red-light); padding:8px 12px; border-radius:8px; }

  /* APP */
  #app { display:none; }
  #app.visible { display:block; }

  nav {
    display:flex; align-items:center; justify-content:space-between;
    padding:0 32px; height:60px; border-bottom:1px solid var(--border);
    background:var(--surface); position:sticky; top:0; z-index:100;
    box-shadow: var(--shadow-sm);
  }
  .logo { font-weight:700; font-size:1.1rem; color:var(--text); display:flex; align-items:center; gap:8px; }
  .logo-dot { width:8px; height:8px; border-radius:50%; background:var(--accent); }
  .nav-center { display:flex; gap:4px; }
  .nav-tab {
    padding:7px 16px; border-radius:8px; border:none; background:none;
    color:var(--muted); font-family:'Plus Jakarta Sans',sans-serif; font-size:0.88rem;
    font-weight:500; cursor:pointer; transition:all 0.15s;
  }
  .nav-tab.active { background:var(--accent-light); color:var(--accent); font-weight:600; }
  .nav-tab:hover:not(.active) { background:var(--surface2); color:var(--text2); }
  .nav-tab.admin-only { display:none; }
  .nav-right { display:flex; align-items:center; gap:10px; }
  .nav-user {
    font-size:0.82rem; color:var(--text2); background:var(--surface2);
    padding:6px 12px; border-radius:8px; border:1px solid var(--border);
    font-weight:500;
  }
  .nav-user span { color:var(--accent); }
  .btn-logout {
    padding:6px 14px; border-radius:8px; border:1.5px solid var(--border);
    background:none; color:var(--muted); font-family:'Plus Jakarta Sans',sans-serif;
    font-size:0.82rem; cursor:pointer; transition:all 0.2s; font-weight:500;
  }
  .btn-logout:hover { border-color:var(--red); color:var(--red); background:var(--red-light); }

  .page { display:none; padding:28px 32px; max-width:980px; margin:0 auto; }
  .page.active { display:block; }

  .section-title { font-size:1.4rem; font-weight:700; color:var(--text); margin-bottom:4px; }
  .section-sub { color:var(--muted); font-size:0.87rem; margin-bottom:24px; }

  .form-card {
    background:var(--surface); border:1px solid var(--border); border-radius:14px;
    padding:26px; margin-bottom:18px; box-shadow:var(--shadow-sm);
  }
  .form-row { margin-bottom:16px; }
  .form-row label { display:block; font-size:0.78rem; color:var(--text2); margin-bottom:5px; font-weight:600; text-transform:uppercase; letter-spacing:0.4px; }
  .form-row input, .form-row select, .form-row textarea {
    width:100%; padding:10px 14px; background:var(--surface2); border:1.5px solid var(--border);
    border-radius:9px; color:var(--text); font-family:'Plus Jakarta Sans',sans-serif;
    font-size:0.93rem; transition:border-color 0.2s;
  }
  .form-row input:focus, .form-row select:focus, .form-row textarea:focus { outline:none; border-color:var(--accent); background:white; }
  .form-row textarea { resize:vertical; min-height:80px; }

  .products-label { font-size:0.78rem; color:var(--text2); margin-bottom:10px; font-weight:600; text-transform:uppercase; letter-spacing:0.4px; }
  .product-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(185px,1fr)); gap:9px; margin-bottom:14px; }
  .product-item {
    background:var(--surface2); border:1.5px solid var(--border); border-radius:10px;
    padding:11px 13px; display:flex; align-items:center; gap:9px;
    cursor:pointer; transition:all 0.15s; user-select:none;
  }
  .product-item:hover { border-color:var(--accent); background:var(--accent-light); }
  .product-item.selected { border-color:var(--accent); background:var(--accent-light); }
  .product-check {
    width:18px; height:18px; border:2px solid var(--border2); border-radius:5px;
    display:flex; align-items:center; justify-content:center; font-size:11px;
    transition:all 0.15s; flex-shrink:0; background:white;
  }
  .product-item.selected .product-check { background:var(--accent); border-color:var(--accent); color:white; }
  .product-name { font-size:0.87rem; flex:1; font-weight:500; color:var(--text2); }
  .product-item.selected .product-name { color:var(--accent); }
  .product-qty {
    width:48px; padding:4px 6px; background:white; border:1.5px solid var(--border);
    border-radius:6px; color:var(--text); font-size:0.83rem; text-align:center;
    font-family:'Plus Jakarta Sans',sans-serif;
  }
  .product-qty:focus { outline:none; border-color:var(--accent); }

  .custom-product-row { display:flex; gap:8px; margin-top:10px; }
  .custom-product-row input { flex:1; }
  .btn-add {
    padding:10px 15px; background:var(--surface2); border:1.5px solid var(--border);
    border-radius:9px; color:var(--accent); cursor:pointer; font-family:'Plus Jakarta Sans',sans-serif;
    font-size:0.87rem; white-space:nowrap; transition:all 0.2s; font-weight:600;
  }
  .btn-add:hover { border-color:var(--accent); background:var(--accent-light); }

  .btn-submit {
    width:100%; padding:12px; background:var(--accent); color:white; font-weight:700;
    border:none; border-radius:10px; font-size:0.95rem; cursor:pointer;
    font-family:'Plus Jakarta Sans',sans-serif; transition:background 0.2s;
    box-shadow: 0 4px 12px rgba(79,110,247,0.25);
  }
  .btn-submit:hover { background:var(--accent-dark); }
  .btn-submit:disabled { opacity:0.5; cursor:not-allowed; box-shadow:none; }

  .success-msg {
    background:var(--green-light); border:1px solid rgba(34,160,107,0.3); color:var(--green);
    border-radius:10px; padding:13px; text-align:center; margin-top:14px;
    display:none; font-weight:500; font-size:0.9rem;
  }

  /* STATS */
  .stats-row { display:grid; grid-template-columns:repeat(4,1fr); gap:14px; margin-bottom:24px; }
  .stat-card {
    background:var(--surface); border:1px solid var(--border); border-radius:12px;
    padding:18px 20px; box-shadow:var(--shadow-sm);
  }
  .stat-num { font-size:1.9rem; font-weight:700; color:var(--text); }
  .stat-lbl { font-size:0.75rem; color:var(--muted); margin-top:3px; font-weight:500; text-transform:uppercase; letter-spacing:0.4px; }
  .stat-icon { font-size:1.3rem; margin-bottom:6px; }

  .filter-bar { display:flex; gap:6px; margin-bottom:18px; flex-wrap:wrap; }
  .filter-btn {
    padding:6px 14px; border-radius:20px; border:1.5px solid var(--border);
    background:var(--surface); color:var(--muted); font-family:'Plus Jakarta Sans',sans-serif;
    font-size:0.82rem; cursor:pointer; transition:all 0.15s; font-weight:500;
  }
  .filter-btn.active { border-color:var(--accent); color:var(--accent); background:var(--accent-light); font-weight:600; }
  .filter-btn:hover:not(.active) { border-color:var(--border2); color:var(--text2); }

  .request-card {
    background:var(--surface); border:1px solid var(--border); border-radius:13px;
    padding:18px 20px; margin-bottom:12px; box-shadow:var(--shadow-sm);
    transition:box-shadow 0.2s;
  }
  .request-card:hover { box-shadow: var(--shadow); }
  .req-header { display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:12px; gap:12px; }
  .req-meta { flex:1; }
  .req-name { font-size:0.98rem; font-weight:700; color:var(--text); }
  .req-by { font-size:0.76rem; color:var(--accent); margin-top:2px; font-weight:600; }
  .req-date { font-size:0.75rem; color:var(--muted); margin-top:2px; }
  .req-phone { font-size:0.81rem; color:var(--text2); margin-top:1px; }

  .badge { padding:4px 11px; border-radius:20px; font-size:0.73rem; font-weight:700; white-space:nowrap; flex-shrink:0; letter-spacing:0.2px; }
  .badge-hediye { background:rgba(79,110,247,0.1); color:var(--accent); }
  .badge-yeniden { background:var(--blue-light); color:var(--blue); }
  .badge-iptal { background:var(--red-light); color:var(--red); }

  .req-products { margin-bottom:11px; }
  .req-product-row {
    display:flex; align-items:center; gap:8px; padding:6px 10px;
    background:var(--surface2); border-radius:7px; margin-bottom:4px; font-size:0.86rem; color:var(--text2);
  }
  .qty-badge {
    background:var(--accent-light); padding:2px 8px; border-radius:5px;
    font-size:0.76rem; color:var(--accent); font-weight:700;
  }
  .req-note { font-size:0.82rem; color:var(--muted); margin-bottom:11px; font-style:italic; }
  .req-address { font-size:0.82rem; color:var(--text2); margin-bottom:11px; }

  .req-actions { display:flex; gap:7px; flex-wrap:wrap; }
  .btn-action {
    padding:7px 13px; border-radius:8px; border:1.5px solid transparent;
    font-family:'Plus Jakarta Sans',sans-serif; font-size:0.81rem; font-weight:600;
    cursor:pointer; transition:all 0.15s;
  }
  .btn-gonder { background:var(--green-light); color:var(--green); border-color:rgba(34,160,107,0.25); }
  .btn-gonder:hover { background:#d4f0e6; }
  .btn-onayla { background:var(--blue-light); color:var(--blue); border-color:rgba(0,145,255,0.25); }
  .btn-onayla:hover { background:#cce8ff; }
  .btn-iptal-a { background:var(--red-light); color:var(--red); border-color:rgba(229,72,77,0.25); }
  .btn-iptal-a:hover { background:#ffd9da; }
  .btn-sil { background:var(--surface2); color:var(--muted); border-color:var(--border); }
  .btn-sil:hover { background:var(--red-light); color:var(--red); border-color:rgba(229,72,77,0.25); }

  .status-chip { padding:5px 11px; border-radius:7px; font-size:0.78rem; font-weight:700; }
  .status-bekliyor { background:var(--orange-light); color:var(--orange); }
  .status-gonderildi { background:var(--green-light); color:var(--green); }
  .status-iptal { background:var(--red-light); color:var(--red); }
  .status-onaylandi { background:var(--blue-light); color:var(--blue); }

  .empty-state { text-align:center; padding:60px 20px; color:var(--muted); }
  .empty-icon { font-size:3rem; margin-bottom:12px; }
  .loading { text-align:center; padding:40px; color:var(--muted); }
  .spinner {
    display:inline-block; width:22px; height:22px; border:2px solid var(--border);
    border-top-color:var(--accent); border-radius:50%; animation:spin 0.7s linear infinite; margin-bottom:8px;
  }
  @keyframes spin { to { transform:rotate(360deg); } }

  /* STAFF */
  .staff-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(250px,1fr)); gap:12px; margin-bottom:22px; }
  .staff-card {
    background:var(--surface2); border:1.5px solid var(--border); border-radius:12px;
    padding:16px 18px; display:flex; align-items:center; justify-content:space-between;
  }
  .staff-name { font-weight:700; font-size:0.93rem; color:var(--text); }
  .staff-role { font-size:0.77rem; margin-top:3px; font-weight:600; }
  .role-badge-admin { color:var(--accent); }
  .role-badge-destek { color:var(--blue); }

  .add-staff-form h3 { font-size:0.93rem; font-weight:700; margin-bottom:14px; color:var(--text); }
  .form-grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:12px; }

  .product-manage-row { display:flex; gap:8px; margin-bottom:12px; }
  .product-list-item {
    display:flex; align-items:center; justify-content:space-between;
    padding:10px 14px; background:var(--surface2); border:1px solid var(--border);
    border-radius:8px; margin-bottom:6px; font-size:0.89rem; color:var(--text2); font-weight:500;
  }
  .btn-remove { background:none; border:none; color:var(--muted); cursor:pointer; font-size:1rem; padding:2px 6px; border-radius:4px; transition:all 0.15s; }
  .btn-remove:hover { background:var(--red-light); color:var(--red); }

  .divider { border:none; border-top:1px solid var(--border); margin:20px 0; }
  .card-title { font-size:1rem; font-weight:700; margin-bottom:16px; color:var(--text); display:flex; align-items:center; gap:8px; }

  .toast {
    position:fixed; bottom:24px; right:24px; background:var(--surface);
    border:1.5px solid var(--green); color:var(--text); padding:11px 18px;
    border-radius:10px; font-size:0.87rem; font-weight:500; z-index:9999;
    opacity:0; transform:translateY(8px); transition:all 0.3s; pointer-events:none;
    box-shadow: var(--shadow);
  }
  .toast.show { opacity:1; transform:translateY(0); }

  @media(max-width:640px) {
    nav { padding:0 16px; flex-wrap:wrap; height:auto; padding:10px 16px; gap:8px; }
    .page { padding:20px 16px; }
    .stats-row { grid-template-columns:repeat(2,1fr); }
    .product-grid { grid-template-columns:1fr 1fr; }
    .form-grid-2 { grid-template-columns:1fr; }
  }
</style>
</head>
<body>

<div class="toast" id="toast"></div>

<!-- LOGIN -->
<div id="login-page">
  <div class="login-box">
    <div class="login-logo">üéÅ</div>
    <div class="login-title">HediyeApp</div>
    <div class="login-sub">Sisteme giri≈ü yapƒ±n</div>
    <input type="text" id="login-user" placeholder="Kullanƒ±cƒ± adƒ±" onkeydown="if(event.key==='Enter')doLogin()">
    <input type="password" id="login-pass" placeholder="≈ûifre" onkeydown="if(event.key==='Enter')doLogin()">
    <button class="btn-login" onclick="doLogin()">Giri≈ü Yap</button>
    <div class="login-error" id="login-error">‚ùå Kullanƒ±cƒ± adƒ± veya ≈üifre hatalƒ±</div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <nav>
    <div class="logo"><div class="logo-dot"></div> HediyeApp</div>
    <div class="nav-center">
      <button class="nav-tab active" onclick="showPage('talepler',this)">üìã Talepler</button>
      <button class="nav-tab" onclick="showPage('yeni',this)">‚ûï Yeni Talep</button>
      <button class="nav-tab admin-only" id="tab-admin" onclick="showPage('admin',this)">‚öôÔ∏è Y√∂netim</button>
    </div>
    <div class="nav-right">
      <div class="nav-user">üë§ <span id="current-user-label"></span></div>
      <button class="btn-logout" onclick="doLogout()">√áƒ±kƒ±≈ü</button>
    </div>
  </nav>

  <!-- TALEPLERs -->
  <div id="page-talepler" class="page active">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;flex-wrap:wrap;gap:10px;">
      <div class="section-title">Talepler</div>
      <button class="btn-action btn-sil" onclick="loadRequests()" style="font-size:0.82rem;">üîÑ Yenile</button>
    </div>
    <div class="section-sub">T√ºm talepleri buradan takip edebilirsiniz.</div>
    <div class="stats-row" id="stats-row"></div>
    <div class="filter-bar">
      <button class="filter-btn active" onclick="setFilter('hepsi',this)">Hepsi</button>
      <button class="filter-btn" onclick="setFilter('bekliyor',this)">‚è≥ Bekliyor</button>
      <button class="filter-btn" onclick="setFilter('onaylandi',this)">‚úîÔ∏è Onaylandƒ±</button>
      <button class="filter-btn" onclick="setFilter('gonderildi',this)">üì¶ G√∂nderildi</button>
      <button class="filter-btn" onclick="setFilter('iptal',this)">‚ùå ƒ∞ptal</button>
    </div>
    <div id="requests-list"><div class="loading"><div class="spinner"></div><div>Y√ºkleniyor...</div></div></div>
  </div>

  <!-- YENƒ∞ TALEP -->
  <div id="page-yeni" class="page">
    <div class="section-title">Yeni Talep</div>
    <div class="section-sub">Yeni bir talep olu≈üturun.</div>
    <div class="form-card">
      <div class="form-row"><label>M√º≈üteri Adƒ± *</label><input type="text" id="c-name" placeholder="Ahmet Yƒ±lmaz"></div>
      <div class="form-row"><label>Telefon</label><input type="text" id="c-phone" placeholder="05xx xxx xx xx"></div>
      <div class="form-row"><label>Teslimat Adresi</label><textarea id="c-address" placeholder="Adres bilgisi..."></textarea></div>
      <div class="form-row">
        <label>Talep T√ºr√º *</label>
        <select id="c-type">
          <option value="hediye">üéÅ Hediye G√∂nderimi</option>
          <option value="yeniden">üîÑ Yeniden G√∂nderim</option>
          <option value="iptal">‚ùå ƒ∞ptal</option>
        </select>
      </div>
      <hr class="divider">
      <div class="products-label">√úr√ºn Se√ßimi *</div>
      <div class="product-grid" id="product-grid"><div class="loading"><div class="spinner"></div></div></div>
      <div class="products-label" style="margin-top:14px">Listede Olmayan √úr√ºn</div>
      <div class="custom-product-row">
        <input type="text" id="custom-name" placeholder="√úr√ºn adƒ±...">
        <input type="number" id="custom-qty" placeholder="Adet" min="1" style="width:80px">
        <button class="btn-add" onclick="addCustomProduct()">+ Ekle</button>
      </div>
      <div id="custom-list" style="margin-top:10px"></div>
      <hr class="divider">
      <div class="form-row"><label>Not</label><textarea id="c-note" placeholder="Ek not..."></textarea></div>
      <button class="btn-submit" id="btn-submit" onclick="submitRequest()">‚úÖ Talep Olu≈ütur</button>
      <div class="success-msg" id="success-msg">üéâ Talep ba≈üarƒ±yla olu≈üturuldu!</div>
    </div>
  </div>

  <!-- ADMƒ∞N -->
  <div id="page-admin" class="page">
    <div class="section-title">Y√∂netim Paneli</div>
    <div class="section-sub">Kullanƒ±cƒ±larƒ± ve √ºr√ºn listesini y√∂netin.</div>
    <div class="form-card">
      <div class="card-title">üë• Destek Ekibi</div>
      <div class="staff-grid" id="staff-grid"><div class="loading"><div class="spinner"></div></div></div>
      <hr class="divider">
      <div class="add-staff-form">
        <h3>‚ûï Yeni Kullanƒ±cƒ± Ekle</h3>
        <div class="form-grid-2">
          <div class="form-row" style="margin-bottom:0"><label>Kullanƒ±cƒ± Adƒ±</label><input type="text" id="new-username" placeholder="kullanici_adi"></div>
          <div class="form-row" style="margin-bottom:0"><label>≈ûifre</label><input type="text" id="new-password" placeholder="≈üifre123"></div>
        </div>
        <div class="form-row" style="margin-top:12px">
          <label>Rol</label>
          <select id="new-role">
            <option value="destek">Destek Ekibi</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <button class="btn-submit" style="margin-top:4px" onclick="addStaff()">‚ûï Kullanƒ±cƒ± Ekle</button>
      </div>
    </div>
    <div class="form-card">
      <div class="card-title">üì¶ √úr√ºn Listesi</div>
      <div class="product-manage-row">
        <input type="text" id="new-product-input" placeholder="Yeni √ºr√ºn adƒ±..."
          style="flex:1;padding:10px 14px;background:var(--surface2);border:1.5px solid var(--border);border-radius:9px;color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;">
        <button class="btn-add" onclick="addMasterProduct()">+ Ekle</button>
      </div>
      <div class="product-list-admin" id="master-product-list"></div>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://uprkbaemdyhtrwdeutxx.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwcmtiYWVtZHlodHJ3ZGV1dHh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxMTEwMTQsImV4cCI6MjA4NzY4NzAxNH0.ibAAvUs9whFId7kI3PTof8BGna3JNBMvgBcutcrUvZU';
const H = {'Content-Type':'application/json','apikey':SUPABASE_KEY,'Authorization':'Bearer '+SUPABASE_KEY};

async function sbGet(t,p=''){const r=await fetch(`${SUPABASE_URL}/rest/v1/${t}?${p}`,{headers:H});return r.json();}
async function sbPost(t,b){const r=await fetch(`${SUPABASE_URL}/rest/v1/${t}`,{method:'POST',headers:{...H,'Prefer':'return=representation'},body:JSON.stringify(b)});return r.json();}
async function sbPatch(t,id,b){const r=await fetch(`${SUPABASE_URL}/rest/v1/${t}?id=eq.${id}`,{method:'PATCH',headers:{...H,'Prefer':'return=representation'},body:JSON.stringify(b)});return r.json();}
async function sbDelete(t,id){await fetch(`${SUPABASE_URL}/rest/v1/${t}?id=eq.${id}`,{method:'DELETE',headers:H});}

let currentUser=null, masterProducts=[], customProducts=[], requests=[], currentFilter='hepsi';

function toast(msg,color='var(--green)'){
  const t=document.getElementById('toast');
  t.textContent=msg; t.style.borderColor=color;
  t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2800);
}

async function doLogin(){
  const username=document.getElementById('login-user').value.trim();
  const password=document.getElementById('login-pass').value;
  if(!username||!password)return;
  try{
    const data=await sbGet('staff',`select=*&username=eq.${encodeURIComponent(username)}&password=eq.${encodeURIComponent(password)}`);
    if(data&&data.length>0){
      currentUser=data[0];
      document.getElementById('login-page').classList.add('hidden');
      document.getElementById('app').classList.add('visible');
      document.getElementById('current-user-label').textContent=currentUser.username;
      document.getElementById('login-error').style.display='none';
      document.getElementById('login-user').value='';
      document.getElementById('login-pass').value='';
      if(currentUser.role==='admin') document.getElementById('tab-admin').style.display='block';
      await loadProducts(); renderProductGrid(); await loadRequests();
    } else { document.getElementById('login-error').style.display='block'; }
  }catch(e){ document.getElementById('login-error').style.display='block'; }
}

function doLogout(){
  currentUser=null;
  document.getElementById('login-page').classList.remove('hidden');
  document.getElementById('app').classList.remove('visible');
  document.getElementById('tab-admin').style.display='none';
  showPage('talepler',document.querySelector('.nav-tab'));
}

function showPage(page,btn){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('page-'+page).classList.add('active');
  if(btn) btn.classList.add('active');
  if(page==='admin'){loadStaff();loadProducts().then(()=>renderMasterProductList());}
}

async function loadProducts(){
  try{const d=await sbGet('products','select=name&order=id.asc');masterProducts=Array.isArray(d)?d.map(p=>p.name):[];}
  catch(e){masterProducts=[];}
}

function renderProductGrid(){
  const g=document.getElementById('product-grid');
  if(!masterProducts.length){g.innerHTML='<div style="color:var(--muted);font-size:0.88rem;grid-column:1/-1">√úr√ºn listesi bo≈ü. Y√∂netim panelinden ekleyin.</div>';return;}
  g.innerHTML='';
  masterProducts.forEach((p,i)=>{
    const d=document.createElement('div');
    d.className='product-item'; d.dataset.name=p;
    d.innerHTML=`<div class="product-check">‚úì</div><span class="product-name">${p}</span><input class="product-qty" type="number" min="1" value="1" id="qty-${i}" onclick="event.stopPropagation()">`;
    d.addEventListener('click',function(e){if(e.target.classList.contains('product-qty'))return;d.classList.toggle('selected');});
    g.appendChild(d);
  });
}

function addCustomProduct(){
  const n=document.getElementById('custom-name').value.trim();
  const q=parseInt(document.getElementById('custom-qty').value)||1;
  if(!n)return;
  customProducts.push({name:n,qty:q});
  document.getElementById('custom-name').value='';
  document.getElementById('custom-qty').value='';
  renderCustomList();
}
function renderCustomList(){
  document.getElementById('custom-list').innerHTML=customProducts.map((p,i)=>
    `<div style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;margin-bottom:6px;font-size:0.87rem;">
      <span style="flex:1;color:var(--text2);font-weight:500">${p.name}</span>
      <span style="color:var(--accent);font-weight:700;font-size:0.8rem">${p.qty} adet</span>
      <button onclick="removeCustom(${i})" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:0.9rem;">‚úï</button>
    </div>`).join('');
}
function removeCustom(i){customProducts.splice(i,1);renderCustomList();}

async function submitRequest(){
  const name=document.getElementById('c-name').value.trim();
  if(!name){toast('M√º≈üteri adƒ± zorunludur!','var(--red)');return;}
  const sel=[];
  document.querySelectorAll('.product-item.selected').forEach(d=>{
    const q=d.querySelector('.product-qty');
    sel.push({name:d.dataset.name,qty:parseInt(q?q.value:1)||1});
  });
  customProducts.forEach(p=>sel.push(p));
  if(!sel.length){toast('En az bir √ºr√ºn se√ßin!','var(--red)');return;}
  const btn=document.getElementById('btn-submit');
  btn.disabled=true; btn.textContent='‚è≥ Kaydediliyor...';
  try{
    await sbPost('requests',{
      name, phone:document.getElementById('c-phone').value.trim(),
      address:document.getElementById('c-address').value.trim(),
      type:document.getElementById('c-type').value,
      products:sel, note:document.getElementById('c-note').value.trim(),
      status:'bekliyor', date:new Date().toLocaleString('tr-TR'),
      created_by:currentUser.username
    });
    ['c-name','c-phone','c-address','c-note'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('c-type').value='hediye';
    document.querySelectorAll('.product-item.selected').forEach(d=>d.classList.remove('selected'));
    customProducts=[]; renderCustomList();
    const m=document.getElementById('success-msg'); m.style.display='block';
    setTimeout(()=>m.style.display='none',3500);
    toast('üéâ Talep olu≈üturuldu!');
  }catch(e){toast('Hata olu≈ütu!','var(--red)');}
  btn.disabled=false; btn.textContent='‚úÖ Talep Olu≈ütur';
}

async function loadRequests(){
  document.getElementById('requests-list').innerHTML='<div class="loading"><div class="spinner"></div><div>Y√ºkleniyor...</div></div>';
  try{requests=await sbGet('requests','select=*&order=id.desc');if(!Array.isArray(requests))requests=[];}
  catch(e){requests=[];}
  renderStats(); renderRequests();
}

function renderStats(){
  const t=requests.length, b=requests.filter(r=>r.status==='bekliyor').length,
        g=requests.filter(r=>r.status==='gonderildi').length, i=requests.filter(r=>r.status==='iptal').length;
  document.getElementById('stats-row').innerHTML=`
    <div class="stat-card"><div class="stat-icon">üìã</div><div class="stat-num">${t}</div><div class="stat-lbl">Toplam</div></div>
    <div class="stat-card"><div class="stat-icon">‚è≥</div><div class="stat-num" style="color:var(--orange)">${b}</div><div class="stat-lbl">Bekliyor</div></div>
    <div class="stat-card"><div class="stat-icon">üì¶</div><div class="stat-num" style="color:var(--green)">${g}</div><div class="stat-lbl">G√∂nderildi</div></div>
    <div class="stat-card"><div class="stat-icon">‚ùå</div><div class="stat-num" style="color:var(--red)">${i}</div><div class="stat-lbl">ƒ∞ptal</div></div>`;
}

function setFilter(f,btn){
  currentFilter=f;
  document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active'); renderRequests();
}

function renderRequests(){
  const list=document.getElementById('requests-list');
  const filtered=currentFilter==='hepsi'?requests:requests.filter(r=>r.status===currentFilter);
  if(!filtered.length){list.innerHTML='<div class="empty-state"><div class="empty-icon">üì≠</div><div>G√∂sterilecek talep yok</div></div>';return;}
  const tBadge={hediye:'badge-hediye',yeniden:'badge-yeniden',iptal:'badge-iptal'};
  const tLabel={hediye:'üéÅ Hediye',yeniden:'üîÑ Yeniden',iptal:'‚ùå ƒ∞ptal'};
  const sCls={bekliyor:'status-bekliyor',gonderildi:'status-gonderildi',iptal:'status-iptal',onaylandi:'status-onaylandi'};
  const sLbl={bekliyor:'‚è≥ Bekliyor',gonderildi:'üì¶ G√∂nderildi',iptal:'‚ùå ƒ∞ptal',onaylandi:'‚úîÔ∏è Onaylandƒ±'};
  list.innerHTML=filtered.map(req=>`
    <div class="request-card">
      <div class="req-header">
        <div class="req-meta">
          <div class="req-name">${req.name}</div>
          ${req.created_by?`<div class="req-by">üìù ${req.created_by}</div>`:''}
          <div class="req-phone">${req.phone||'‚Äî'}</div>
          <div class="req-date">${req.date}</div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
          <span class="badge ${tBadge[req.type]||''}">${tLabel[req.type]||req.type}</span>
          <span class="status-chip ${sCls[req.status]||''}">${sLbl[req.status]||req.status}</span>
        </div>
      </div>
      <div class="req-products">${(req.products||[]).map(p=>`<div class="req-product-row"><span>${p.name}</span><span class="qty-badge">${p.qty} adet</span></div>`).join('')}</div>
      ${req.address?`<div class="req-address">üìç ${req.address}</div>`:''}
      ${req.note?`<div class="req-note">üí¨ ${req.note}</div>`:''}
      <div class="req-actions">
        <button class="btn-action btn-gonder" onclick="updateStatus(${req.id},'gonderildi')">üì¶ G√∂nderdim</button>
        <button class="btn-action btn-onayla" onclick="updateStatus(${req.id},'onaylandi')">‚úîÔ∏è Onayla</button>
        <button class="btn-action btn-iptal-a" onclick="updateStatus(${req.id},'iptal')">‚ùå ƒ∞ptal</button>
        <button class="btn-action btn-sil" onclick="deleteRequest(${req.id})">üóë Sil</button>
      </div>
    </div>`).join('');
}

async function updateStatus(id,status){
  await sbPatch('requests',id,{status});
  const r=requests.find(r=>r.id===id); if(r) r.status=status;
  renderRequests(); renderStats();
  const l={gonderildi:'üì¶ G√∂nderildi',onaylandi:'‚úîÔ∏è Onaylandƒ±',iptal:'‚ùå ƒ∞ptal edildi'};
  toast(l[status]||'G√ºncellendi');
}

async function deleteRequest(id){
  if(!confirm('Bu talep silinsin mi?'))return;
  await sbDelete('requests',id);
  requests=requests.filter(r=>r.id!==id);
  renderRequests(); renderStats();
  toast('üóë Silindi','var(--muted)');
}

async function loadStaff(){
  try{
    const data=await sbGet('staff','select=*&order=id.asc');
    const grid=document.getElementById('staff-grid');
    if(!Array.isArray(data)||!data.length){grid.innerHTML='<div style="color:var(--muted)">Hen√ºz kullanƒ±cƒ± yok</div>';return;}
    grid.innerHTML=data.map(s=>`
      <div class="staff-card">
        <div>
          <div class="staff-name">üë§ ${s.username}</div>
          <div class="staff-role ${s.role==='admin'?'role-badge-admin':'role-badge-destek'}">${s.role==='admin'?'‚≠ê Admin':'üéß Destek Ekibi'}</div>
        </div>
        <div>
          ${s.username!==currentUser.username
            ?`<button class="btn-action btn-sil" onclick="deleteStaff(${s.id},'${s.username}')">üóë Sil</button>`
            :'<span style="font-size:0.75rem;color:var(--muted)">(sen)</span>'}
        </div>
      </div>`).join('');
  }catch(e){}
}

async function addStaff(){
  const username=document.getElementById('new-username').value.trim();
  const password=document.getElementById('new-password').value.trim();
  const role=document.getElementById('new-role').value;
  if(!username||!password){toast('Kullanƒ±cƒ± adƒ± ve ≈üifre zorunludur!','var(--red)');return;}
  await sbPost('staff',{username,password,role});
  document.getElementById('new-username').value='';
  document.getElementById('new-password').value='';
  toast('‚úÖ Kullanƒ±cƒ± eklendi'); loadStaff();
}

async function deleteStaff(id,username){
  if(!confirm(`"${username}" silinsin mi?`))return;
  await sbDelete('staff',id);
  toast('üóë Kullanƒ±cƒ± silindi','var(--muted)'); loadStaff();
}

async function addMasterProduct(){
  const v=document.getElementById('new-product-input').value.trim();
  if(!v)return;
  await sbPost('products',{name:v});
  document.getElementById('new-product-input').value='';
  await loadProducts(); renderMasterProductList(); renderProductGrid();
  toast('‚úÖ √úr√ºn eklendi');
}

async function removeMasterProduct(i){
  const name=masterProducts[i];
  const d=await sbGet('products',`select=id&name=eq.${encodeURIComponent(name)}`);
  if(d&&d[0]) await sbDelete('products',d[0].id);
  await loadProducts(); renderMasterProductList(); renderProductGrid();
  toast('üóë √úr√ºn silindi','var(--muted)');
}

function renderMasterProductList(){
  document.getElementById('master-product-list').innerHTML=masterProducts.map((p,i)=>
    `<div class="product-list-item"><span>${p}</span><button class="btn-remove" onclick="removeMasterProduct(${i})">‚úï</button></div>`
  ).join('');
}
</script>
</body>
</html>
