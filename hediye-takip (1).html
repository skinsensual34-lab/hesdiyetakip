<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hediye Takip Sistemi</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#0d0d0d; --surface:#161616; --surface2:#1e1e1e; --surface3:#252525;
    --border:#2a2a2a; --accent:#c8a96e; --accent2:#e8c98e; --text:#f0ece4;
    --muted:#8a8078; --green:#4caf7d; --red:#e05c5c; --blue:#5b9bd5; --orange:#e08c3c;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }

  /* LOGIN */
  #login-page {
    min-height:100vh; display:flex; align-items:center; justify-content:center;
    background: radial-gradient(ellipse at 60% 40%, rgba(200,169,110,0.07) 0%, transparent 70%);
  }
  #login-page.hidden { display:none; }
  .login-box {
    background:var(--surface); border:1px solid var(--border); border-radius:20px;
    padding:48px 40px; width:380px; text-align:center;
    box-shadow: 0 24px 60px rgba(0,0,0,0.4);
  }
  .login-logo { font-family:'Playfair Display',serif; font-size:2rem; color:var(--accent); margin-bottom:6px; }
  .login-sub { color:var(--muted); font-size:0.88rem; margin-bottom:32px; }
  .login-box input {
    width:100%; padding:13px 16px; background:var(--surface2); border:1px solid var(--border);
    border-radius:10px; color:var(--text); font-size:0.95rem; margin-bottom:12px;
    font-family:'DM Sans',sans-serif; transition:border-color 0.2s;
  }
  .login-box input:focus { outline:none; border-color:var(--accent); }
  .btn-login {
    width:100%; padding:13px; background:var(--accent); color:#0d0d0d; font-weight:700;
    border:none; border-radius:10px; font-size:1rem; cursor:pointer;
    font-family:'DM Sans',sans-serif; transition:background 0.2s; margin-top:4px;
  }
  .btn-login:hover { background:var(--accent2); }
  .login-error { color:var(--red); font-size:0.85rem; margin-top:10px; display:none; }

  /* APP */
  #app { display:none; }
  #app.visible { display:block; }

  nav {
    display:flex; align-items:center; justify-content:space-between;
    padding:16px 32px; border-bottom:1px solid var(--border);
    background:var(--surface); position:sticky; top:0; z-index:100;
  }
  .logo { font-family:'Playfair Display',serif; font-size:1.3rem; color:var(--accent); }
  .nav-right { display:flex; align-items:center; gap:12px; }
  .nav-user {
    font-size:0.82rem; color:var(--muted);
    background:var(--surface2); padding:6px 12px; border-radius:8px;
    border:1px solid var(--border);
  }
  .nav-user span { color:var(--accent); font-weight:600; }
  .nav-tabs { display:flex; gap:8px; }
  .nav-tab {
    padding:7px 18px; border-radius:8px; border:1px solid transparent;
    background:none; color:var(--muted); font-family:'DM Sans',sans-serif;
    font-size:0.88rem; cursor:pointer; transition:all 0.2s;
  }
  .nav-tab.active { background:var(--accent); color:#0d0d0d; font-weight:600; }
  .nav-tab:hover:not(.active) { border-color:var(--border); color:var(--text); }
  .nav-tab.admin-only { display:none; }
  .btn-logout {
    padding:7px 14px; border-radius:8px; border:1px solid var(--border);
    background:none; color:var(--muted); font-family:'DM Sans',sans-serif;
    font-size:0.82rem; cursor:pointer; transition:all 0.2s;
  }
  .btn-logout:hover { border-color:var(--red); color:var(--red); }

  .page { display:none; padding:32px; max-width:960px; margin:0 auto; }
  .page.active { display:block; }

  .section-title { font-family:'Playfair Display',serif; font-size:1.6rem; color:var(--accent); margin-bottom:4px; }
  .section-sub { color:var(--muted); font-size:0.88rem; margin-bottom:28px; }

  .form-card { background:var(--surface); border:1px solid var(--border); border-radius:16px; padding:28px; margin-bottom:20px; }
  .form-row { margin-bottom:18px; }
  .form-row label { display:block; font-size:0.8rem; color:var(--muted); margin-bottom:6px; text-transform:uppercase; letter-spacing:0.5px; }
  .form-row input, .form-row select, .form-row textarea {
    width:100%; padding:11px 14px; background:var(--surface2); border:1px solid var(--border);
    border-radius:10px; color:var(--text); font-family:'DM Sans',sans-serif; font-size:0.95rem; transition:border-color 0.2s;
  }
  .form-row input:focus, .form-row select:focus, .form-row textarea:focus { outline:none; border-color:var(--accent); }
  .form-row select option { background:var(--surface2); }
  .form-row textarea { resize:vertical; min-height:80px; }

  .products-label { font-size:0.8rem; color:var(--muted); margin-bottom:10px; text-transform:uppercase; letter-spacing:0.5px; }
  .product-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(190px,1fr)); gap:10px; margin-bottom:16px; }
  .product-item {
    background:var(--surface2); border:1px solid var(--border); border-radius:10px;
    padding:11px 13px; display:flex; align-items:center; gap:10px;
    cursor:pointer; transition:all 0.15s; user-select:none;
  }
  .product-item:hover { border-color:var(--accent); }
  .product-item.selected { border-color:var(--accent); background:rgba(200,169,110,0.1); }
  .product-check {
    width:18px; height:18px; border:2px solid var(--border); border-radius:5px;
    display:flex; align-items:center; justify-content:center; font-size:11px;
    transition:all 0.15s; flex-shrink:0;
  }
  .product-item.selected .product-check { background:var(--accent); border-color:var(--accent); color:#0d0d0d; }
  .product-name { font-size:0.88rem; flex:1; }
  .product-qty {
    width:50px; padding:4px 6px; background:var(--surface3); border:1px solid var(--border);
    border-radius:6px; color:var(--text); font-size:0.85rem; text-align:center; font-family:'DM Sans',sans-serif;
  }
  .product-qty:focus { outline:none; border-color:var(--accent); }

  .custom-product-row { display:flex; gap:8px; margin-top:10px; }
  .custom-product-row input { flex:1; }
  .btn-add {
    padding:10px 16px; background:var(--surface3); border:1px solid var(--border);
    border-radius:10px; color:var(--accent); cursor:pointer; font-family:'DM Sans',sans-serif;
    font-size:0.88rem; white-space:nowrap; transition:all 0.2s;
  }
  .btn-add:hover { border-color:var(--accent); }

  .btn-submit {
    width:100%; padding:13px; background:var(--accent); color:#0d0d0d; font-weight:700;
    border:none; border-radius:12px; font-size:1rem; cursor:pointer;
    font-family:'DM Sans',sans-serif; transition:background 0.2s;
  }
  .btn-submit:hover { background:var(--accent2); }
  .btn-submit:disabled { opacity:0.5; cursor:not-allowed; }

  .success-msg {
    background:rgba(76,175,125,0.12); border:1px solid var(--green); color:var(--green);
    border-radius:10px; padding:14px; text-align:center; margin-top:16px; display:none;
  }

  /* STATS */
  .stats-row { display:grid; grid-template-columns:repeat(4,1fr); gap:14px; margin-bottom:28px; }
  .stat-card { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:18px; text-align:center; }
  .stat-num { font-size:2rem; font-weight:700; color:var(--accent); font-family:'Playfair Display',serif; }
  .stat-lbl { font-size:0.75rem; color:var(--muted); margin-top:4px; text-transform:uppercase; letter-spacing:0.5px; }

  .filter-bar { display:flex; gap:8px; margin-bottom:20px; flex-wrap:wrap; }
  .filter-btn {
    padding:6px 15px; border-radius:20px; border:1px solid var(--border);
    background:none; color:var(--muted); font-family:'DM Sans',sans-serif;
    font-size:0.83rem; cursor:pointer; transition:all 0.15s;
  }
  .filter-btn.active, .filter-btn:hover { border-color:var(--accent); color:var(--accent); }

  .request-card { background:var(--surface); border:1px solid var(--border); border-radius:14px; padding:20px; margin-bottom:14px; }
  .req-header { display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:12px; gap:12px; }
  .req-meta { flex:1; }
  .req-name { font-size:1rem; font-weight:600; }
  .req-by { font-size:0.78rem; color:var(--accent); margin-top:1px; }
  .req-date { font-size:0.76rem; color:var(--muted); margin-top:2px; }
  .req-phone { font-size:0.82rem; color:var(--muted); }

  .badge { padding:4px 12px; border-radius:20px; font-size:0.74rem; font-weight:600; white-space:nowrap; flex-shrink:0; }
  .badge-hediye { background:rgba(200,169,110,0.15); color:var(--accent); border:1px solid rgba(200,169,110,0.3); }
  .badge-yeniden { background:rgba(91,155,213,0.15); color:var(--blue); border:1px solid rgba(91,155,213,0.3); }
  .badge-iptal { background:rgba(224,92,92,0.15); color:var(--red); border:1px solid rgba(224,92,92,0.3); }

  .req-products { margin-bottom:12px; }
  .req-product-row {
    display:flex; align-items:center; gap:8px; padding:6px 10px;
    background:var(--surface2); border-radius:8px; margin-bottom:5px; font-size:0.87rem;
  }
  .qty-badge { background:var(--surface3); padding:2px 8px; border-radius:5px; font-size:0.77rem; color:var(--accent); font-weight:600; }
  .req-note { font-size:0.83rem; color:var(--muted); margin-bottom:12px; font-style:italic; }
  .req-address { font-size:0.83rem; color:var(--muted); margin-bottom:12px; }

  .req-actions { display:flex; gap:8px; flex-wrap:wrap; }
  .btn-action {
    padding:7px 14px; border-radius:8px; border:1px solid transparent;
    font-family:'DM Sans',sans-serif; font-size:0.82rem; font-weight:500; cursor:pointer; transition:all 0.15s;
  }
  .btn-gonder { background:rgba(76,175,125,0.15); color:var(--green); border-color:rgba(76,175,125,0.3); }
  .btn-gonder:hover { background:rgba(76,175,125,0.25); }
  .btn-onayla { background:rgba(91,155,213,0.15); color:var(--blue); border-color:rgba(91,155,213,0.3); }
  .btn-onayla:hover { background:rgba(91,155,213,0.25); }
  .btn-iptal-a { background:rgba(224,92,92,0.15); color:var(--red); border-color:rgba(224,92,92,0.3); }
  .btn-iptal-a:hover { background:rgba(224,92,92,0.25); }
  .btn-sil { background:rgba(100,100,100,0.12); color:var(--muted); border-color:rgba(100,100,100,0.2); }
  .btn-sil:hover { background:rgba(224,92,92,0.12); color:var(--red); }

  .status-chip { padding:5px 12px; border-radius:8px; font-size:0.8rem; font-weight:600; }
  .status-bekliyor { background:rgba(224,140,60,0.15); color:var(--orange); }
  .status-gonderildi { background:rgba(76,175,125,0.15); color:var(--green); }
  .status-iptal { background:rgba(224,92,92,0.15); color:var(--red); }
  .status-onaylandi { background:rgba(91,155,213,0.15); color:var(--blue); }

  .empty-state { text-align:center; padding:60px 20px; color:var(--muted); }
  .empty-icon { font-size:3rem; margin-bottom:12px; }
  .loading { text-align:center; padding:40px; color:var(--muted); }
  .spinner { display:inline-block; width:22px; height:22px; border:2px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin 0.7s linear infinite; margin-bottom:8px; }
  @keyframes spin { to { transform:rotate(360deg); } }

  /* ADMIN - STAFF */
  .staff-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:14px; margin-bottom:24px; }
  .staff-card {
    background:var(--surface); border:1px solid var(--border); border-radius:14px; padding:18px;
    display:flex; align-items:center; justify-content:space-between;
  }
  .staff-info .staff-name { font-weight:600; font-size:0.95rem; }
  .staff-info .staff-role { font-size:0.78rem; color:var(--muted); margin-top:2px; }
  .role-badge-admin { color:var(--accent); }
  .role-badge-destek { color:var(--blue); }
  .staff-actions { display:flex; gap:6px; }

  .add-staff-form { background:var(--surface); border:1px solid var(--border); border-radius:14px; padding:22px; }
  .add-staff-form h3 { font-size:0.95rem; font-weight:600; margin-bottom:16px; color:var(--accent); }
  .form-grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:12px; }

  /* PRODUCT MANAGER */
  .product-manage-row { display:flex; gap:8px; margin-bottom:12px; }
  .product-list-admin { margin-top:12px; }
  .product-list-item {
    display:flex; align-items:center; justify-content:space-between;
    padding:10px 14px; background:var(--surface2); border:1px solid var(--border);
    border-radius:8px; margin-bottom:6px; font-size:0.9rem;
  }
  .btn-remove { background:none; border:none; color:var(--red); cursor:pointer; font-size:1rem; padding:2px 6px; border-radius:4px; }
  .btn-remove:hover { background:rgba(224,92,92,0.1); }

  .divider { border:none; border-top:1px solid var(--border); margin:22px 0; }

  .toast {
    position:fixed; bottom:24px; right:24px; background:var(--surface); border:1px solid var(--green);
    color:var(--text); padding:11px 18px; border-radius:10px; font-size:0.87rem;
    z-index:9999; opacity:0; transform:translateY(8px); transition:all 0.3s; pointer-events:none;
  }
  .toast.show { opacity:1; transform:translateY(0); }

  @media(max-width:600px) {
    nav { padding:12px 16px; flex-wrap:wrap; gap:10px; }
    .page { padding:20px 16px; }
    .stats-row { grid-template-columns:repeat(2,1fr); }
    .product-grid { grid-template-columns:1fr 1fr; }
    .form-grid-2 { grid-template-columns:1fr; }
  }
</style>
</head>
<body>

<div class="toast" id="toast"></div>

<!-- LOGIN -->
<div id="login-page">
  <div class="login-box">
    <div class="login-logo">üéÅ HediyeApp</div>
    <div class="login-sub">Sisteme giri≈ü yapƒ±n</div>
    <input type="text" id="login-user" placeholder="Kullanƒ±cƒ± adƒ±" onkeydown="if(event.key==='Enter')doLogin()">
    <input type="password" id="login-pass" placeholder="≈ûifre" onkeydown="if(event.key==='Enter')doLogin()">
    <button class="btn-login" onclick="doLogin()">Giri≈ü Yap</button>
    <div class="login-error" id="login-error">‚ùå Kullanƒ±cƒ± adƒ± veya ≈üifre hatalƒ±</div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <nav>
    <div class="logo">üéÅ HediyeApp</div>
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="showPage('talepler',this)">üìã Talepler</button>
      <button class="nav-tab" onclick="showPage('yeni',this)">‚ûï Yeni Talep</button>
      <button class="nav-tab admin-only" id="tab-admin" onclick="showPage('admin',this)">‚öôÔ∏è Y√∂netim</button>
    </div>
    <div class="nav-right">
      <div class="nav-user">üë§ <span id="current-user-label"></span></div>
      <button class="btn-logout" onclick="doLogout()">√áƒ±kƒ±≈ü</button>
    </div>
  </nav>

  <!-- TALEPLERs -->
  <div id="page-talepler" class="page active">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;flex-wrap:wrap;gap:10px;">
      <div class="section-title">Talepler</div>
      <button class="btn-action btn-sil" onclick="loadRequests()" style="font-size:0.82rem;">üîÑ Yenile</button>
    </div>
    <div class="section-sub">T√ºm talepleri buradan takip edebilirsiniz.</div>
    <div class="stats-row" id="stats-row"></div>
    <div class="filter-bar">
      <button class="filter-btn active" onclick="setFilter('hepsi',this)">Hepsi</button>
      <button class="filter-btn" onclick="setFilter('bekliyor',this)">‚è≥ Bekliyor</button>
      <button class="filter-btn" onclick="setFilter('onaylandi',this)">‚úîÔ∏è Onaylandƒ±</button>
      <button class="filter-btn" onclick="setFilter('gonderildi',this)">üì¶ G√∂nderildi</button>
      <button class="filter-btn" onclick="setFilter('iptal',this)">‚ùå ƒ∞ptal</button>
    </div>
    <div id="requests-list"><div class="loading"><div class="spinner"></div><div>Y√ºkleniyor...</div></div></div>
  </div>

  <!-- YENƒ∞ TALEP -->
  <div id="page-yeni" class="page">
    <div class="section-title">Yeni Talep</div>
    <div class="section-sub">Yeni bir talep olu≈üturun.</div>
    <div class="form-card">
      <div class="form-row"><label>M√º≈üteri Adƒ± *</label><input type="text" id="c-name" placeholder="Ahmet Yƒ±lmaz"></div>
      <div class="form-row"><label>Telefon</label><input type="text" id="c-phone" placeholder="05xx xxx xx xx"></div>
      <div class="form-row"><label>Teslimat Adresi</label><textarea id="c-address" placeholder="Adres bilgisi..."></textarea></div>
      <div class="form-row">
        <label>Talep T√ºr√º *</label>
        <select id="c-type">
          <option value="hediye">üéÅ Hediye G√∂nderimi</option>
          <option value="yeniden">üîÑ Yeniden G√∂nderim</option>
          <option value="iptal">‚ùå ƒ∞ptal</option>
        </select>
      </div>
      <hr class="divider">
      <div class="products-label">√úr√ºn Se√ßimi *</div>
      <div class="product-grid" id="product-grid"><div class="loading"><div class="spinner"></div></div></div>
      <div class="products-label" style="margin-top:14px">Listede Olmayan √úr√ºn</div>
      <div class="custom-product-row">
        <input type="text" id="custom-name" placeholder="√úr√ºn adƒ±...">
        <input type="number" id="custom-qty" placeholder="Adet" min="1" style="width:80px">
        <button class="btn-add" onclick="addCustomProduct()">+ Ekle</button>
      </div>
      <div id="custom-list" style="margin-top:10px"></div>
      <hr class="divider">
      <div class="form-row"><label>Not</label><textarea id="c-note" placeholder="Ek not..."></textarea></div>
      <button class="btn-submit" id="btn-submit" onclick="submitRequest()">‚úÖ Talep Olu≈ütur</button>
      <div class="success-msg" id="success-msg">üéâ Talep ba≈üarƒ±yla olu≈üturuldu!</div>
    </div>
  </div>

  <!-- ADMƒ∞N -->
  <div id="page-admin" class="page">
    <div class="section-title">Y√∂netim Paneli</div>
    <div class="section-sub">Kullanƒ±cƒ±larƒ± ve √ºr√ºn listesini y√∂netin.</div>

    <!-- STAFF -->
    <div class="form-card">
      <h3 style="font-size:1.1rem;font-weight:600;margin-bottom:18px;color:var(--accent);">üë• Destek Ekibi</h3>
      <div class="staff-grid" id="staff-grid"><div class="loading"><div class="spinner"></div></div></div>
      <hr class="divider">
      <div class="add-staff-form">
        <h3>‚ûï Yeni Kullanƒ±cƒ± Ekle</h3>
        <div class="form-grid-2">
          <div class="form-row" style="margin-bottom:0">
            <label>Kullanƒ±cƒ± Adƒ±</label>
            <input type="text" id="new-username" placeholder="kullanici_adi">
          </div>
          <div class="form-row" style="margin-bottom:0">
            <label>≈ûifre</label>
            <input type="text" id="new-password" placeholder="≈üifre123">
          </div>
        </div>
        <div class="form-row" style="margin-top:12px">
          <label>Rol</label>
          <select id="new-role">
            <option value="destek">Destek Ekibi</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <button class="btn-submit" style="margin-top:4px" onclick="addStaff()">‚ûï Kullanƒ±cƒ± Ekle</button>
      </div>
    </div>

    <!-- √úR√úNLER -->
    <div class="form-card">
      <h3 style="font-size:1.1rem;font-weight:600;margin-bottom:18px;color:var(--accent);">üì¶ √úr√ºn Listesi</h3>
      <div class="product-manage-row">
        <input type="text" id="new-product-input" placeholder="Yeni √ºr√ºn adƒ±..."
          style="flex:1;padding:10px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:'DM Sans',sans-serif;">
        <button class="btn-add" onclick="addMasterProduct()">+ Ekle</button>
      </div>
      <div class="product-list-admin" id="master-product-list"></div>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://uprkbaemdyhtrwdeutxx.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwcmtiYWVtZHlodHJ3ZGV1dHh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxMTEwMTQsImV4cCI6MjA4NzY4NzAxNH0.ibAAvUs9whFId7kI3PTof8BGna3JNBMvgBcutcrUvZU';
const H = {'Content-Type':'application/json','apikey':SUPABASE_KEY,'Authorization':'Bearer '+SUPABASE_KEY};

async function sbGet(t,p=''){const r=await fetch(`${SUPABASE_URL}/rest/v1/${t}?${p}`,{headers:H});return r.json();}
async function sbPost(t,b){const r=await fetch(`${SUPABASE_URL}/rest/v1/${t}`,{method:'POST',headers:{...H,'Prefer':'return=representation'},body:JSON.stringify(b)});return r.json();}
async function sbPatch(t,id,b){const r=await fetch(`${SUPABASE_URL}/rest/v1/${t}?id=eq.${id}`,{method:'PATCH',headers:{...H,'Prefer':'return=representation'},body:JSON.stringify(b)});return r.json();}
async function sbDelete(t,id){await fetch(`${SUPABASE_URL}/rest/v1/${t}?id=eq.${id}`,{method:'DELETE',headers:H});}

let currentUser = null;
let masterProducts = [], customProducts = [], requests = [], currentFilter = 'hepsi';

function toast(msg, color='var(--green)'){
  const t=document.getElementById('toast');
  t.textContent=msg; t.style.borderColor=color;
  t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2800);
}

// ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ
async function doLogin(){
  const username = document.getElementById('login-user').value.trim();
  const password = document.getElementById('login-pass').value;
  if(!username||!password) return;
  try {
    const data = await sbGet('staff', `select=*&username=eq.${encodeURIComponent(username)}&password=eq.${encodeURIComponent(password)}`);
    if(data && data.length > 0){
      currentUser = data[0];
      document.getElementById('login-page').classList.add('hidden');
      document.getElementById('app').classList.add('visible');
      document.getElementById('current-user-label').textContent = currentUser.username;
      document.getElementById('login-error').style.display='none';
      document.getElementById('login-user').value='';
      document.getElementById('login-pass').value='';
      // Admin sekmesini g√∂ster
      if(currentUser.role === 'admin'){
        document.getElementById('tab-admin').style.display='block';
      }
      await loadProducts();
      renderProductGrid();
      await loadRequests();
    } else {
      document.getElementById('login-error').style.display='block';
    }
  } catch(e){ document.getElementById('login-error').style.display='block'; }
}

function doLogout(){
  currentUser = null;
  document.getElementById('login-page').classList.remove('hidden');
  document.getElementById('app').classList.remove('visible');
  document.getElementById('tab-admin').style.display='none';
  showPage('talepler', document.querySelector('.nav-tab'));
}

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ
function showPage(page, btn){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('page-'+page).classList.add('active');
  if(btn) btn.classList.add('active');
  if(page==='admin') loadStaff();
}

// ‚îÄ‚îÄ PRODUCTS ‚îÄ‚îÄ
async function loadProducts(){
  try{const d=await sbGet('products','select=name&order=id.asc');masterProducts=Array.isArray(d)?d.map(p=>p.name):[];}
  catch(e){masterProducts=[];}
}

function renderProductGrid(){
  const g=document.getElementById('product-grid');
  if(!masterProducts.length){g.innerHTML='<div style="color:var(--muted);font-size:0.88rem;grid-column:1/-1">√úr√ºn listesi bo≈ü. Y√∂netim panelinden ekleyin.</div>';return;}
  g.innerHTML='';
  masterProducts.forEach((p,i)=>{
    const d=document.createElement('div');
    d.className='product-item'; d.dataset.name=p;
    d.innerHTML=`<div class="product-check">‚úì</div><span class="product-name">${p}</span><input class="product-qty" type="number" min="1" value="1" id="qty-${i}" onclick="event.stopPropagation()">`;
    d.addEventListener('click',function(e){if(e.target.classList.contains('product-qty'))return;d.classList.toggle('selected');});
    g.appendChild(d);
  });
}

function addCustomProduct(){
  const n=document.getElementById('custom-name').value.trim();
  const q=parseInt(document.getElementById('custom-qty').value)||1;
  if(!n)return;
  customProducts.push({name:n,qty:q});
  document.getElementById('custom-name').value='';
  document.getElementById('custom-qty').value='';
  renderCustomList();
}
function renderCustomList(){
  document.getElementById('custom-list').innerHTML=customProducts.map((p,i)=>
    `<div style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--surface2);border-radius:8px;margin-bottom:6px;font-size:0.88rem;">
      <span style="flex:1">${p.name}</span><span style="color:var(--accent);font-weight:600">${p.qty} adet</span>
      <button onclick="removeCustom(${i})" style="background:none;border:none;color:var(--red);cursor:pointer;">‚úï</button>
    </div>`).join('');
}
function removeCustom(i){customProducts.splice(i,1);renderCustomList();}

// ‚îÄ‚îÄ SUBMIT ‚îÄ‚îÄ
async function submitRequest(){
  const name=document.getElementById('c-name').value.trim();
  if(!name){toast('M√º≈üteri adƒ± zorunludur!','var(--red)');return;}
  const sel=[];
  document.querySelectorAll('.product-item.selected').forEach(d=>{
    const q=d.querySelector('.product-qty');
    sel.push({name:d.dataset.name,qty:parseInt(q?q.value:1)||1});
  });
  customProducts.forEach(p=>sel.push(p));
  if(!sel.length){toast('En az bir √ºr√ºn se√ßin!','var(--red)');return;}

  const btn=document.getElementById('btn-submit');
  btn.disabled=true; btn.textContent='‚è≥ Kaydediliyor...';
  try{
    await sbPost('requests',{
      name, phone:document.getElementById('c-phone').value.trim(),
      address:document.getElementById('c-address').value.trim(),
      type:document.getElementById('c-type').value,
      products:sel,
      note:document.getElementById('c-note').value.trim(),
      status:'bekliyor',
      date:new Date().toLocaleString('tr-TR'),
      created_by: currentUser.username
    });
    ['c-name','c-phone','c-address','c-note'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('c-type').value='hediye';
    document.querySelectorAll('.product-item.selected').forEach(d=>d.classList.remove('selected'));
    customProducts=[]; renderCustomList();
    const m=document.getElementById('success-msg');
    m.style.display='block'; setTimeout(()=>m.style.display='none',3500);
    toast('üéâ Talep olu≈üturuldu!');
  }catch(e){toast('Hata olu≈ütu!','var(--red)');}
  btn.disabled=false; btn.textContent='‚úÖ Talep Olu≈ütur';
}

// ‚îÄ‚îÄ REQUESTS ‚îÄ‚îÄ
async function loadRequests(){
  document.getElementById('requests-list').innerHTML='<div class="loading"><div class="spinner"></div><div>Y√ºkleniyor...</div></div>';
  try{requests=await sbGet('requests','select=*&order=id.desc');if(!Array.isArray(requests))requests=[];}
  catch(e){requests=[];}
  renderStats(); renderRequests();
}

function renderStats(){
  const t=requests.length,b=requests.filter(r=>r.status==='bekliyor').length,
        g=requests.filter(r=>r.status==='gonderildi').length,i=requests.filter(r=>r.status==='iptal').length;
  document.getElementById('stats-row').innerHTML=`
    <div class="stat-card"><div class="stat-num">${t}</div><div class="stat-lbl">Toplam</div></div>
    <div class="stat-card"><div class="stat-num" style="color:var(--orange)">${b}</div><div class="stat-lbl">Bekliyor</div></div>
    <div class="stat-card"><div class="stat-num" style="color:var(--green)">${g}</div><div class="stat-lbl">G√∂nderildi</div></div>
    <div class="stat-card"><div class="stat-num" style="color:var(--red)">${i}</div><div class="stat-lbl">ƒ∞ptal</div></div>`;
}

function setFilter(f,btn){
  currentFilter=f;
  document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active'); renderRequests();
}

function renderRequests(){
  const list=document.getElementById('requests-list');
  const filtered=currentFilter==='hepsi'?requests:requests.filter(r=>r.status===currentFilter);
  if(!filtered.length){list.innerHTML='<div class="empty-state"><div class="empty-icon">üì≠</div><div>G√∂sterilecek talep yok</div></div>';return;}
  const tBadge={hediye:'badge-hediye',yeniden:'badge-yeniden',iptal:'badge-iptal'};
  const tLabel={hediye:'üéÅ Hediye',yeniden:'üîÑ Yeniden',iptal:'‚ùå ƒ∞ptal'};
  const sCls={bekliyor:'status-bekliyor',gonderildi:'status-gonderildi',iptal:'status-iptal',onaylandi:'status-onaylandi'};
  const sLbl={bekliyor:'‚è≥ Bekliyor',gonderildi:'üì¶ G√∂nderildi',iptal:'‚ùå ƒ∞ptal',onaylandi:'‚úîÔ∏è Onaylandƒ±'};
  list.innerHTML=filtered.map(req=>`
    <div class="request-card">
      <div class="req-header">
        <div class="req-meta">
          <div class="req-name">${req.name}</div>
          ${req.created_by?`<div class="req-by">üìù ${req.created_by}</div>`:''}
          <div class="req-phone">${req.phone||'‚Äî'}</div>
          <div class="req-date">${req.date}</div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
          <span class="badge ${tBadge[req.type]||''}">${tLabel[req.type]||req.type}</span>
          <span class="status-chip ${sCls[req.status]||''}">${sLbl[req.status]||req.status}</span>
        </div>
      </div>
      <div class="req-products">${(req.products||[]).map(p=>`<div class="req-product-row"><span>${p.name}</span><span class="qty-badge">${p.qty} adet</span></div>`).join('')}</div>
      ${req.address?`<div class="req-address">üìç ${req.address}</div>`:''}
      ${req.note?`<div class="req-note">üí¨ ${req.note}</div>`:''}
      <div class="req-actions">
        <button class="btn-action btn-gonder" onclick="updateStatus(${req.id},'gonderildi')">üì¶ G√∂nderdim</button>
        <button class="btn-action btn-onayla" onclick="updateStatus(${req.id},'onaylandi')">‚úîÔ∏è Onayla</button>
        <button class="btn-action btn-iptal-a" onclick="updateStatus(${req.id},'iptal')">‚ùå ƒ∞ptal</button>
        <button class="btn-action btn-sil" onclick="deleteRequest(${req.id})">üóë Sil</button>
      </div>
    </div>`).join('');
}

async function updateStatus(id,status){
  await sbPatch('requests',id,{status});
  const r=requests.find(r=>r.id===id); if(r) r.status=status;
  renderRequests(); renderStats();
  const l={gonderildi:'üì¶ G√∂nderildi',onaylandi:'‚úîÔ∏è Onaylandƒ±',iptal:'‚ùå ƒ∞ptal edildi'};
  toast(l[status]||'G√ºncellendi');
}

async function deleteRequest(id){
  if(!confirm('Bu talep silinsin mi?'))return;
  await sbDelete('requests',id);
  requests=requests.filter(r=>r.id!==id);
  renderRequests(); renderStats();
  toast('üóë Silindi','var(--muted)');
}

// ‚îÄ‚îÄ STAFF ‚îÄ‚îÄ
async function loadStaff(){
  try{
    const data=await sbGet('staff','select=*&order=id.asc');
    const grid=document.getElementById('staff-grid');
    if(!Array.isArray(data)||!data.length){grid.innerHTML='<div style="color:var(--muted)">Hen√ºz kullanƒ±cƒ± yok</div>';return;}
    grid.innerHTML=data.map(s=>`
      <div class="staff-card">
        <div class="staff-info">
          <div class="staff-name">üë§ ${s.username}</div>
          <div class="staff-role ${s.role==='admin'?'role-badge-admin':'role-badge-destek'}">${s.role==='admin'?'‚≠ê Admin':'üéß Destek Ekibi'}</div>
        </div>
        <div class="staff-actions">
          ${s.username!==currentUser.username?`<button class="btn-action btn-sil" onclick="deleteStaff(${s.id},'${s.username}')">üóë</button>`:'<span style="font-size:0.75rem;color:var(--muted)">(sen)</span>'}
        </div>
      </div>`).join('');
  }catch(e){}
}

async function addStaff(){
  const username=document.getElementById('new-username').value.trim();
  const password=document.getElementById('new-password').value.trim();
  const role=document.getElementById('new-role').value;
  if(!username||!password){toast('Kullanƒ±cƒ± adƒ± ve ≈üifre zorunludur!','var(--red)');return;}
  await sbPost('staff',{username,password,role});
  document.getElementById('new-username').value='';
  document.getElementById('new-password').value='';
  toast('‚úÖ Kullanƒ±cƒ± eklendi');
  loadStaff();
}

async function deleteStaff(id,username){
  if(!confirm(`"${username}" kullanƒ±cƒ±sƒ± silinsin mi?`))return;
  await sbDelete('staff',id);
  toast('üóë Kullanƒ±cƒ± silindi','var(--muted)');
  loadStaff();
}

// ‚îÄ‚îÄ ADMIN PRODUCTS ‚îÄ‚îÄ
async function addMasterProduct(){
  const v=document.getElementById('new-product-input').value.trim();
  if(!v)return;
  await sbPost('products',{name:v});
  document.getElementById('new-product-input').value='';
  await loadProducts(); renderMasterProductList(); renderProductGrid();
  toast('‚úÖ √úr√ºn eklendi');
}

async function removeMasterProduct(i){
  const name=masterProducts[i];
  const d=await sbGet('products',`select=id&name=eq.${encodeURIComponent(name)}`);
  if(d&&d[0]) await sbDelete('products',d[0].id);
  await loadProducts(); renderMasterProductList(); renderProductGrid();
  toast('üóë √úr√ºn silindi','var(--muted)');
}

function renderMasterProductList(){
  document.getElementById('master-product-list').innerHTML=masterProducts.map((p,i)=>
    `<div class="product-list-item"><span>${p}</span><button class="btn-remove" onclick="removeMasterProduct(${i})">‚úï</button></div>`
  ).join('');
}
</script>
</body>
</html>
